---
layout: article
title: IMSDK链路说明
tags: IM,TeXt
article_header:
  type: cover
  image:
    src: /screenshot.jpg
---
# IM长连接接入APM

IM使用TCP长连接进行通信，特点是“一次建链，多次请求”，其关注的监控指标和现有APM监控的Http连接有所不同，下面简述一下长连接的监控需求。

<!--more-->

## 1 建链指标

TCP链建立关注的指标比较简单，没有Http的DNS、以及鉴权、首帧数据时间等记录需求，主要就是建链时间和相关的用户设备信息

| 变量名称 | 变量描述 | 是否必须 | 备注 |
| --- | --- | --- | --- |
| targetIp | 建立长连接的目标IP资源（包含ip和端口） | YES | 有可能改为IP的别名，非直接IP地址
| selfIp | 自身的IP资源（仅包含ip） | NO | 
| connectTime | TCP建链connect耗时 | YES | 
| connectResult | 连接操作结果码 |  YES | 可以区分建链结果，成功or失败（以及区分失败类型）


>> 注意：此处没有列举app版本、网络状态、类型、运营商等基础信息，不代表不关注，只是认为默认会带上。


## 2 请求指标

建链完成之后，才能基于TCP连接进行一次次请求，由于原始的IM连接中没有类似url的域名概念，本次为接入APM监控会进行调整，直接上报IP无法进行筛选，改为上报IP的别名，便于进行可视化管理。

| 变量名称 | 变量描述 | 是否必须 | 备注 |
| --- | --- | --- | --- |
| requestIp | 请求的目标IP资源（包含ip和端口） | YES | 有可能改为IP的别名，非直接IP地址
| resultCode | 单次请求的结果码 | YES | 区分成功or失败，以及各种失败类型
| ExceptionMsg | 异常情况描述 | YES | 除成功外，需要对于出现的服务异常进行描述，超时也包含在其中

>> 由于现有的网络监控模型是以连接为单位传输的，而长连接涉及一次连接上的多次请求，故而在建链成功后发送的后续请求，只会传输本次请求的指标，而建链的指标不会填写（或是按照要求置为特殊数值）。